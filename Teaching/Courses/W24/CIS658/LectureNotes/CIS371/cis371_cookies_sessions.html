
<html lang="en">
<head>
  <title>GVSU School of Computing</title>
  <meta charset="utf-8">
  <style>
    .type-this {
      background-color: #ffddff;
      white-space: nowrap;
    }

    .to-me {
      color: #0000ff;
      font-size: 110%;
    }

    .question, .q {
      color: #cc00cc;
      font-size: 110%;
    }

    .question, .q > ul {
      color: #000000;
      font-size: 91%;
    }

    li p {
      margin: 0;
    }

    .listHeader {
      padding-bottom: 0;
      margin-bottom: 0;
    }

    ul, ol {
      padding-top: 0;
      margin-top: 0;
    }

    table.bottomBorders td {
      border-bottom: 1px solid black;
    }

    .indent25 {
      margin: 25px;
    }

  pre {
    display: inline-block;
    background-color: #f0f0f0;
    padding: 3px;
    padding-right: 10px;
  }

    
    .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .cm {
  color: #999988;
  font-style: italic;
}
.highlight .cp {
  color: #999999;
  font-weight: bold;
}
.highlight .c1 {
  color: #999988;
  font-style: italic;
}
.highlight .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cpf {
  color: #999988;
  font-style: italic;
}
.highlight .err {
  color: #a61717;
  background-color: #e3d2d2;
}
.highlight .gd {
  color: #000000;
  background-color: #ffdddd;
}
.highlight .ge {
  color: #000000;
  font-style: italic;
}
.highlight .gr {
  color: #aa0000;
}
.highlight .gh {
  color: #999999;
}
.highlight .gi {
  color: #000000;
  background-color: #ddffdd;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
  font-weight: bold;
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .gt {
  color: #aa0000;
}
.highlight .kc {
  color: #000000;
  font-weight: bold;
}
.highlight .kd {
  color: #000000;
  font-weight: bold;
}
.highlight .kn {
  color: #000000;
  font-weight: bold;
}
.highlight .kp {
  color: #000000;
  font-weight: bold;
}
.highlight .kr {
  color: #000000;
  font-weight: bold;
}
.highlight .kt {
  color: #445588;
  font-weight: bold;
}
.highlight .k, .highlight .kv {
  color: #000000;
  font-weight: bold;
}
.highlight .mf {
  color: #009999;
}
.highlight .mh {
  color: #009999;
}
.highlight .il {
  color: #009999;
}
.highlight .mi {
  color: #009999;
}
.highlight .mo {
  color: #009999;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #009999;
}
.highlight .sa {
  color: #000000;
  font-weight: bold;
}
.highlight .sb {
  color: #d14;
}
.highlight .sc {
  color: #d14;
}
.highlight .sd {
  color: #d14;
}
.highlight .s2 {
  color: #d14;
}
.highlight .se {
  color: #d14;
}
.highlight .sh {
  color: #d14;
}
.highlight .si {
  color: #d14;
}
.highlight .sx {
  color: #d14;
}
.highlight .sr {
  color: #009926;
}
.highlight .s1 {
  color: #d14;
}
.highlight .ss {
  color: #990073;
}
.highlight .s, .highlight .dl {
  color: #d14;
}
.highlight .na {
  color: #008080;
}
.highlight .bp {
  color: #999999;
}
.highlight .nb {
  color: #0086B3;
}
.highlight .nc {
  color: #445588;
  font-weight: bold;
}
.highlight .no {
  color: #008080;
}
.highlight .nd {
  color: #3c5d5d;
  font-weight: bold;
}
.highlight .ni {
  color: #800080;
}
.highlight .ne {
  color: #990000;
  font-weight: bold;
}
.highlight .nf, .highlight .fm {
  color: #990000;
  font-weight: bold;
}
.highlight .nl {
  color: #990000;
  font-weight: bold;
}
.highlight .nn {
  color: #555555;
}
.highlight .nt {
  color: #000080;
}
.highlight .vc {
  color: #008080;
}
.highlight .vg {
  color: #008080;
}
.highlight .vi {
  color: #008080;
}
.highlight .nv, .highlight .vm {
  color: #008080;
}
.highlight .ow {
  color: #000000;
  font-weight: bold;
}
.highlight .o {
  color: #000000;
  font-weight: bold;
}
.highlight .w {
  color: #bbbbbb;
}
.highlight {
  background-color: #f8f8f8;
}
    
    .highlight {
      display: inline-block;
      background-color: #ffffff;
    }

    pre.highlight {
      background-color: #f0f0f0;
      padding-right: 10px;
    }

  </style>
</head>
<body>
<main id="content">
  <h1 id="cookies">Cookies</h1>

<ul>
  <li>At a high level, a cookie is simply a piece of state (key/value pair) that the server asks the browser to store
    <ul>
      <li>Browser returns that key/value pair upon next visit to that site</li>
    </ul>
  </li>
  <li>Can be as simple/trivial as remembering a color/language preference.</li>
  <li>Today cookies form the foundation of sessions.  (More on that later.)</li>
  <li>Also used for tracking :(</li>
  <li>Background: The web was originally designed to be stateless; but, that can (obviously) be inconvenient.
    <ul>
      <li>HTTP itself <em>is</em> stateless.  Any necessary state must be maintained by either the browser or the server.</li>
      <li>Client has to remember <em>something</em>. Even if most data is on the server, we need a way for the server to 
know who is “talking” to it.</li>
    </ul>
  </li>
  <li>Cookies are sent in request and response headers
    <ul>
      <li class="to-me">Run <code>BasicHTTPSTransaction</code> (which connects to <code>wwww.gvsu.edu</code>) and notice the <code>Set-Cookie</code> header</li>
      <li class="to-me">Open Incognito window in Chrome.
        <ul>
          <li>Visit <code>wwww.gvsu.edu</code>; Watch response headers</li>
          <li>Reload the page.  Notice request <code>Cookie</code> header.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Check out <a href="https://faculty.computing.gvsu.edu/kurmasz/simpleCookie.php">https://faculty.computing.gvsu.edu/kurmasz/simpleCookie.php</a>
    <ul>
      <li>Source code here <a href="https://github.com/kurmasz-SampleCode/CIS371-SampleCode/tree/master/Cookies">https://github.com/kurmasz-SampleCode/CIS371-SampleCode/tree/master/Cookies</a></li>
    </ul>
  </li>
  <li>Cookie properties: <a href="https://www.php.net/manual/en/function.setcookie.php">https://www.php.net/manual/en/function.setcookie.php</a>
    <ul>
      <li><code>name</code>:  The key in the key/value pair</li>
      <li><code>value</code>: The value in the key/value pair</li>
      <li><code>expires</code>: When the cookie expires (i.e., when the browser deletes it)
        <ul>
          <li>Sent as a UNIX timestamp (e.g., <code>Thu, 20-Feb-2020 16:03:58 GMT</code> )</li>
          <li>Most frameworks will generate this string for you.</li>
          <li>If no expires value is given, cookie expires when the browser session ends.
            <ul>
              <li>This is one reason some web sites suggest you close your browser when finished.</li>
              <li><em>But</em> some browsers now restore sessions.  When in doubt, set up an explicit expiration.</li>
            </ul>
          </li>
        </ul>
      </li>
      <li><code>path</code>: The path on the server where the cookie is available.
        <ul>
          <li>If set to <code>/Teaching/Courses/CIS371</code>, then cookie only visible to files in that directory or below.</li>
          <li>Defaults to <code>/</code> (at least in Express) which means  all files on server see cookie</li>
        </ul>
      </li>
      <li><code>domain</code>: The (sub)domain that the cookie is available to.
        <ul>
          <li>For example, should a cookie set on <code>cis.gvsu.edu</code> be available to <code>www.gvsu.edu</code>?</li>
        </ul>
      </li>
      <li><code>secure</code>: Only return cookie over <code>HTTPS</code>.
        <ul>
          <li>This affects browser only.  It is the server’s responsibility to decide whether to send a cookie.</li>
          <li>“secure” cookies will be sent to localhost over http.</li>
        </ul>
      </li>
      <li><code>httponly</code>: When <code>true</code> cookie is <em>not</em> accessible through JavaScript.</li>
    </ul>
  </li>
  <li>To “delete” a cookie, just give it an expiration time in the past.</li>
  <li>Rails interface to cookies:  <a href="https://api.rubyonrails.org/v6.0.2/classes/ActionDispatch/Cookies.html">https://api.rubyonrails.org/v6.0.2/classes/ActionDispatch/Cookies.html</a>
    <ul>
      <li>TLDR:  Treat an object named <code>cookies</code> as a hash within a controller.</li>
    </ul>
  </li>
  <li>Express interface to cookies: <a href="https://expressjs.com/en/api.html#res.cookie">https://expressjs.com/en/api.html#res.cookie</a>
    <ul>
      <li>Best used with <code>cookie-parser</code> middleware <a href="https://www.npmjs.com/package/cookie-parser">https://www.npmjs.com/package/cookie-parser</a></li>
    </ul>
  </li>
  <li>Walk through <a href="https://github.com/kurmasz-SampleCode/CIS371-SampleCode/tree/master/Cookies">https://github.com/kurmasz-SampleCode/CIS371-SampleCode/tree/master/Cookies</a>
    <ul>
      <li>listCookies</li>
      <li>setCookies</li>
      <li>set/list with path</li>
      <li>Show expiration</li>
    </ul>
  </li>
  <li>Paths are especially important in a shared system (e.g., web pages like <code>~kurmasz</code> where my cookies could interfere with another student/professor)</li>
  <li>Remember:
    <ul>
      <li>Browsers don’t have to accept cookies.  Avoid using them for “mission critical” features.</li>
      <li>Browsers can also “lie” about cookie values.  You can’t trust them.
        <ul>
          <li>For example, if you set a product price as a cookie, the client might lower that price when visiting the site again.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Tracking:
    <ul>
      <li class="q">How do cookies get abused?
        <ul>
          <li>Remember, cookies are stored by domain.  Suppose both  <code>cutekittens.com</code> and <code>petlife.com</code> both contain an image tag with a source of <code>eviltracker.com</code>.  Then any cookies set when visiting site will be returned when visiting the second.  The tracker than then tell that a single user visited both sites.  (This is how you can shop for something on Amazon then have ads pop up elsewhere.)</li>
          <li>This is what is meant by “third-party cookies”:  You visit <code>a.com</code> and get asked to save/send a cookie from <code>b.com</code> that has some kind of embedded content.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><em>Remember</em>: Cookies sent to/from address in the request (i.e., <code>eviltracker.com</code>).  This is <em>not</em> 
 influenced by the address of the page that contains the link (e.g., <code>cutekittens.com</code> or <code>petlife.com</code>).</li>
  <li>Client side:  <code>CookieStore</code> is a new JavaScript that allows you to access cookies in the browser
    <ul>
      <li><a href="https://developer.mozilla.org/en-US/docs/Web/API/CookieStore">https://developer.mozilla.org/en-US/docs/Web/API/CookieStore</a></li>
      <li>Example usage:  <code>await cookieStore.getAll()</code>  (Object is named <code>cookieStore</code>)</li>
      <li>Only works over https or localhost</li>
      <li>cookies must <em>not</em> be created with <code>httpOnly</code></li>
    </ul>
  </li>
</ul>

<h1 id="session">Session</h1>

<ul>
  <li>HTTP itself is stateless; but the server doesn’t have to be.
    <ul>
      <li>Clear example:  Servers that store data in a database.</li>
    </ul>
  </li>
  <li>The server can remember a user’s data; but still needs some way of <em>reliably</em> knowing who the user is 
during each request.
    <ul>
      <li>Don’t want users to be able to easily fake their identity.</li>
    </ul>
  </li>
  <li>Basic idea:
    <ul>
      <li>Server sends a cookie with a long random string.</li>
      <li>That long, random string is a key to a set of data for that particular user.</li>
      <li>When the user visits another page, the cookie is returned and matched up with the data.</li>
      <li>Make sure string is long and random enough that it can’t be guessed.</li>
      <li>String is often encrypted/hashed data to detect tampering.</li>
    </ul>
  </li>
  <li>Rails automatically sets up a session for you (whether you need one or not)
    <ul>
      <li>Session data is stored in a special hash named <code>session</code>
        <ul>
          <li>For example, you can save the current user’s ID once she has logged in.</li>
        </ul>
      </li>
      <li>By default, this data is sent in an encrypted cookie with every page.</li>
      <li>Because data is encrypted, you can trust that it hasn’t been modified</li>
      <li>call <code>reset_session</code> when necessary.</li>
      <li>Storing the session in the cookie is easiest (make sure it is “tamper-resistant”), but you can also
        <ul>
          <li>Store it in server memory (e.g., using <code>memcache</code>)</li>
          <li>Store it in a database.</li>
          <li>See <a href="https://www.justinweiss.com/articles/how-rails-sessions-work/">https://www.justinweiss.com/articles/how-rails-sessions-work/</a> for details</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>To use sessions in Express, install the <code>express-session</code> package
    <ul>
      <li><a href="https://www.npmjs.com/package/express-session">https://www.npmjs.com/package/express-session</a></li>
      <li>This package stores session data on the server <em>not</em> in a cookie.</li>
      <li>For production applications, read the documentation about session storage carefully.</li>
      <li>If you do store session data in a cookie (which you shouldn’t), make sure the 
cookie is secure (i.e., encrypted) so that it is obvious if a user modifies it.</li>
    </ul>
  </li>
  <li>Give session cookies a short expiration time.</li>
</ul>


</main>
</body>
</html>
