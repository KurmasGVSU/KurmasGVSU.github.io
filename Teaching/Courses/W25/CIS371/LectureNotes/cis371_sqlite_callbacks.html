
<html lang="en">
<head>
  <title>GVSU School of Computing</title>
  <meta charset="utf-8">
  <style>
    .type-this {
      background-color: #ffddff;
      white-space: nowrap;
    }

    .to-me {
      color: #0000ff;
      font-size: 110%;
    }

    .question, .q {
      color: #cc00cc;
      font-size: 110%;
    }

    .question, .q > ul {
      color: #000000;
      font-size: 91%;
    }

    li p {
      margin: 0;
    }

    .listHeader {
      padding-bottom: 0;
      margin-bottom: 0;
    }

    ul, ol {
      padding-top: 0;
      margin-top: 0;
    }

    table.bottomBorders td {
      border-bottom: 1px solid black;
    }

    .indent25 {
      margin: 25px;
    }

  .strikethrough {
      text-decoration: line-through;
  }

  pre {
    display: inline-block;
    background-color: #f0f0f0;
    padding: 3px;
    padding-right: 10px;
  }

    
    .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .cm {
  color: #999988;
  font-style: italic;
}
.highlight .cp {
  color: #999999;
  font-weight: bold;
}
.highlight .c1 {
  color: #999988;
  font-style: italic;
}
.highlight .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cpf {
  color: #999988;
  font-style: italic;
}
.highlight .err {
  color: #a61717;
  background-color: #e3d2d2;
}
.highlight .gd {
  color: #000000;
  background-color: #ffdddd;
}
.highlight .ge {
  color: #000000;
  font-style: italic;
}
.highlight .gr {
  color: #aa0000;
}
.highlight .gh {
  color: #999999;
}
.highlight .gi {
  color: #000000;
  background-color: #ddffdd;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
  font-weight: bold;
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .gt {
  color: #aa0000;
}
.highlight .kc {
  color: #000000;
  font-weight: bold;
}
.highlight .kd {
  color: #000000;
  font-weight: bold;
}
.highlight .kn {
  color: #000000;
  font-weight: bold;
}
.highlight .kp {
  color: #000000;
  font-weight: bold;
}
.highlight .kr {
  color: #000000;
  font-weight: bold;
}
.highlight .kt {
  color: #445588;
  font-weight: bold;
}
.highlight .k, .highlight .kv {
  color: #000000;
  font-weight: bold;
}
.highlight .mf {
  color: #009999;
}
.highlight .mh {
  color: #009999;
}
.highlight .il {
  color: #009999;
}
.highlight .mi {
  color: #009999;
}
.highlight .mo {
  color: #009999;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #009999;
}
.highlight .sa {
  color: #000000;
  font-weight: bold;
}
.highlight .sb {
  color: #d14;
}
.highlight .sc {
  color: #d14;
}
.highlight .sd {
  color: #d14;
}
.highlight .s2 {
  color: #d14;
}
.highlight .se {
  color: #d14;
}
.highlight .sh {
  color: #d14;
}
.highlight .si {
  color: #d14;
}
.highlight .sx {
  color: #d14;
}
.highlight .sr {
  color: #009926;
}
.highlight .s1 {
  color: #d14;
}
.highlight .ss {
  color: #990073;
}
.highlight .s, .highlight .dl {
  color: #d14;
}
.highlight .na {
  color: #008080;
}
.highlight .bp {
  color: #999999;
}
.highlight .nb {
  color: #0086B3;
}
.highlight .nc {
  color: #445588;
  font-weight: bold;
}
.highlight .no {
  color: #008080;
}
.highlight .nd {
  color: #3c5d5d;
  font-weight: bold;
}
.highlight .ni {
  color: #800080;
}
.highlight .ne {
  color: #990000;
  font-weight: bold;
}
.highlight .nf, .highlight .fm {
  color: #990000;
  font-weight: bold;
}
.highlight .nl {
  color: #990000;
  font-weight: bold;
}
.highlight .nn {
  color: #555555;
}
.highlight .nt {
  color: #000080;
}
.highlight .vc {
  color: #008080;
}
.highlight .vg {
  color: #008080;
}
.highlight .vi {
  color: #008080;
}
.highlight .nv, .highlight .vm {
  color: #008080;
}
.highlight .ow {
  color: #000000;
  font-weight: bold;
}
.highlight .o {
  color: #000000;
  font-weight: bold;
}
.highlight .w {
  color: #bbbbbb;
}
.highlight {
  background-color: #f8f8f8;
}
    
    .highlight {
      display: inline-block;
      background-color: #ffffff;
    }

    pre.highlight {
      background-color: #f0f0f0;
      padding-right: 10px;
    }

  </style>
</head>
<body>
<main id="content">
  
<h1 id="sqlite-and-callbacks">SQLite and Callbacks</h1>

<ul>
  <li>Next step is to add a real DB to the <code>ExpressMVC</code> example.</li>
  <li>Look at <code>ExpressMVCSqliteCallbacks</code>.</li>
  <li>Includes the <code>sqlite3</code> module
    <ul>
      <li>Main feature of sqlite3 is that it stores the DB in a local file.</li>
      <li>Not performant/scalable; but simple and useful for sample code.</li>
    </ul>
  </li>
  <li class="to-me">Look at <code>SqliteToyDB.js</code>
    <ul>
      <li><code>initialize</code> run 3 SQL commands (a CREATE and two INSERTS).<br />
(In other words, it creates and populates the db)</li>
      <li><code>all</code> runs a SELECT that grabs all Toys in the DB.</li>
      <li><code>find</code> runs a SELECT that looks for a specific toy.</li>
    </ul>
  </li>
  <li class="important">Sqlite calls return data using callbacks only. 
The return value of the method does not contain the requested data.
    <ul>
      <li class="to-me">run <code>callbacksRequired.js</code></li>
      <li>Notice that the return value is a DB object, not the requested toys.</li>
      <li>Notice that the code after <code>db.all</code> runs immediately and results in output
 <em>before</em> the results of the query are printed (even though the code to print 
 the results comes first in the source code).</li>
      <li>Key idea:  DB calls take awhile.  We don’t want to “block” (pause the CPU/Core/Thread) 
and just wait.  Instead, specify the code to run when the data is ready, then move on and 
get something useful done.</li>
    </ul>
  </li>
  <li class="to-me">Show the controller (in <code>index.js</code>)
    <ul>
      <li>Notice the workflow.  (This is not obvious, and may take a minute to figure out.)</li>
      <li>There are <em>two</em> levels of callbacks.  On the one hand, this technically doesn’t matter:
You should be able to treat the <code>allToys</code> method as a “black box” and not concern yourself 
with how it works.  On the other hand, you may have to write code like this yourself someday, so let’s take a look.</li>
      <li>At the top level, the interface/contract for <code>allToys</code> says that you pass it a function that expects an array of <code>Toy</code>s as input, and it will call that function when the list of toys is ready.
(Not too bad:  Array of <code>Toy</code>s appears as if by “magic” and you build a web page from it.)</li>
      <li>But, let’s see how the sausage is made.  Look at the <em>implementation</em> of <code>allToys</code>.  The list of toys comes from the DB.  Specifically, it comes from a call to the Database’s <code>all</code> method, which run the specified SQL statement.    This method also returns data using a callback.  This particular callback function receives two parameters: (1) an object describing any errors, and (2) an Array containing the rows returned by the SQL statement.
        <ul>
          <li>Notice that the rows returned by the DB are <em>not</em> <code>Toy</code> objects.  They are just generic objects that map column names to the value for that column.</li>
          <li>We must write “glue” code that transforms these “generic” objects into our ‘Toy’ objects.</li>
          <li>In this case, the “glue” is trivial: a <code>map</code> that passes the generic object into the <code>Toy</code> constructor.</li>
        </ul>
      </li>
      <li>Once this list of actual <code>Toy</code> objects exists, we want to pass it to the original callback.
That callback was stored in a local parameter named (imaginatively) <code>callback</code>.  So we execute that function and pass the list of <code>Toy</code>s.</li>
      <li>The end result is a callback nested within another callback.</li>
      <li>Nested callbacks are a slippery slope that lead to “callback hell”.
        <ul>
          <li>See <code>SqliteToyDB#extremes</code> for an example.  (Pretend for sake of the “story” that the two SQL statements can’t be combined.)</li>
          <li>Now imagine this code with error handling at each level!</li>
          <li>«http://callbackhell.com/»</li>
          <li><img src="Images/callbackHell.jpg" alt="" /></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


</main>
</body>
</html>
